{{- /*

Intended for inclusion by content adapters. Retrieves data from an external API and
saves it to scratch under the specified name. For different sections, use different
names to avoid concurrency issues, even if the data is the same.


@context {object} root
@context {string} name
@context {string} auth [OPTIONAL]
@context {string} data [OPTIONAL]


@example: {{ partial "_content.html" (dict "root" . "name" "%name%", "auth" "%auth%" "data" "%data%") }}

*/}}

{{ $ACT_AUTH := default (getenv "ACT_AUTH") .auth }}
{{ $ACT_DATA := default (getenv "ACT_DATA") .data }}

{{ $headers := dict "headers" (dict "Cookie" (index (resources.GetRemote $ACT_AUTH (dict "responseHeaders" (slice "Set-cookie"))).Data.Headers "Set-Cookie" )) }}

{{ $records := newScratch }}

<!--------------------------------------------------------------
|                  Requests data for each row                  |
--------------------------------------------------------------->

{{ range $data := $ACT_DATA | unmarshal }}

<!-------------------------------------------------------------
|      Requests the list of records from an external API      |
-------------------------------------------------------------->

    {{ $remote := resources.GetRemote (replace $data.list_url "{id}" $data.id) $headers | unmarshal }}

<!--------------------------------------------------------------
|      Requests info for each record from an external API      |
--------------------------------------------------------------->

    {{ range $remote.results }}
        {{ $records.Set (.id | string) (merge
            (resources.GetRemote (replace $data.info_url "{id}" .id) $headers | unmarshal)
            (resources.GetRemote (replace $data.slot_url "{id}" .id) $headers | unmarshal)) }}
    {{ end }}

{{ end }}

<!-------------------------------------------------------------
|            Merges remote records with local ones            |
-------------------------------------------------------------->

{{ $records = merge $records.Values (default dict .root.Site.Data.activities) }}

<!-------------------------------------------------------------
|          Saves records to global storage for reuse          |
-------------------------------------------------------------->

{{ hugo.Store.Set .name $records }}